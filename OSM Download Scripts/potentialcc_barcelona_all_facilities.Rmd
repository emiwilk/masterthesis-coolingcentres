---
title: "barcelona_all_candidates"
output: html_document
date: "2025-09-10"
---

```{r setup}
library(dplyr)
```

```{r read-csv-files}
# Read all six CSV files
barcelona_community_centres <- read.csv("Data/potential cooling centres/barcelona_community_centres.csv", stringsAsFactors = FALSE, sep = ",")
barcelona_libraries <- read.csv("Data/potential cooling centres/barcelona_libraries.csv", stringsAsFactors = FALSE, sep = ",")
barcelona_museum <- read.csv("Data/potential cooling centres/barcelona_museum.csv", stringsAsFactors = FALSE, sep = ",")
barcelona_schools <- read.csv("Data/potential cooling centres/barcelona_schools.csv", stringsAsFactors = FALSE, sep = ",")
barcelona_social_centres <- read.csv("Data/potential cooling centres/barcelona_social_centres.csv", stringsAsFactors = FALSE, sep = ",")
barcelona_university <- read.csv("Data/potential cooling centres/barcelona_university.csv", stringsAsFactors = FALSE, sep = ",")
```

```{r add-facility-type}
# Add a column to identify the facility type for each dataset
barcelona_community_centres$facility_category <- "community_centre"
barcelona_libraries$facility_category <- "library"
barcelona_museum$facility_category <- "museum"
barcelona_schools$facility_category <- "school"
barcelona_social_centres$facility_category <- "social_centre"
barcelona_university$facility_category <- "university"
```

```{r check-columns}
# Check what columns exist in each dataset
cat("Columns in each dataset:\n")
cat("Community centres:", paste(names(barcelona_community_centres), collapse = ", "), "\n\n")
cat("Libraries:", paste(names(barcelona_libraries), collapse = ", "), "\n\n")
cat("Museums:", paste(names(barcelona_museum), collapse = ", "), "\n\n")
cat("Schools:", paste(names(barcelona_schools), collapse = ", "), "\n\n")
cat("Social centres:", paste(names(barcelona_social_centres), collapse = ", "), "\n\n")
cat("Universities:", paste(names(barcelona_university), collapse = ", "), "\n\n")

# Get all unique columns across all datasets
all_columns <- unique(c(
  names(barcelona_community_centres),
  names(barcelona_libraries),
  names(barcelona_museum),
  names(barcelona_schools),
  names(barcelona_social_centres),
  names(barcelona_university)
))

cat("All unique columns:", paste(all_columns, collapse = ", "), "\n")
```

```{r combine-datasets}
# Use bind_rows to combine all datasets
# This automatically fills missing columns with NA
barcelona_all_facilities <- bind_rows(
  barcelona_community_centres,
  barcelona_libraries,
  barcelona_museum,
  barcelona_schools,
  barcelona_social_centres,
  barcelona_university
)

# Drop the amenity and tourism columns as we added facility type as consistent type column
barcelona_all_facilities <- barcelona_all_facilities %>%
  select(-any_of(c("amenity", "tourism")))


# Check the result
cat("Combined dataset dimensions:", nrow(barcelona_all_facilities), "rows x", ncol(barcelona_all_facilities), "columns\n")
cat("Final columns:", paste(names(barcelona_all_facilities), collapse = ", "), "\n")
```

```{r summary-stats}
# Summary statistics
cat("\nSummary of combined dataset:\n")
cat("Total facilities:", nrow(barcelona_all_facilities), "\n")

cat("\nFacilities by category:\n")
print(table(barcelona_all_facilities$facility_category, useNA = "ifany"))

cat("\nFacilities with names:", sum(!is.na(barcelona_all_facilities$name)), "\n")
cat("Facilities with coordinates:", sum(!is.na(barcelona_all_facilities$x) & !is.na(barcelona_all_facilities$y)), "\n")
```

```{r save-combined-data}
# Save the combined dataset
write.csv(barcelona_all_facilities, "Data/potential cooling centres/barcelona_all_facilities.csv", row.names = FALSE)

cat("Combined data saved as barcelona_all_facilities.csv\n")
cat("Total rows:", nrow(barcelona_all_facilities), "\n")
cat("Total columns:", ncol(barcelona_all_facilities), "\n")
```

```{r preview-data}
# Show first few rows of combined data
cat("\nPreview of combined dataset:\n")
head(barcelona_all_facilities, 10)
```

```{r remove facilities that are cooling centres already}
# Read the CSV files
barcelona_existing <- read.csv("Data/existing cooling centres/barcelona_existing_coolingcentres.csv", sep = ";")
barcelona_all_facilities <- read.csv("Data/potential cooling centres/barcelona_all_facilities.csv", sep = ",")

# Convert to sf objects using x and y columns
barcelona_existing_sf <- st_as_sf(barcelona_existing, coords = c("lon", "lat"), crs = 4326)
barcelona_all_facilities_sf <- st_as_sf(barcelona_all_facilities, coords = c("x", "y"), crs = 4326)

# Transform to a projected CRS to measure in meters
# EPSG:32631 is common for Barcelona  
barcelona_existing_proj <- st_transform(barcelona_existing_sf, 32631)
barcelona_all_facilities_proj <- st_transform(barcelona_all_facilities_sf, 32631)

# Find all facilities within 50 meters of existing cooling centres
barcelona_nearby_matches <- st_is_within_distance(barcelona_all_facilities_proj, barcelona_existing_proj, dist = 50)

# Keep only facilities that are NOT within 20m of any existing cooling centre
barcelona_not_near_existing <- lengths(barcelona_nearby_matches) == 0
barcelona_all_candidates <- barcelona_all_facilities[barcelona_not_near_existing, ]

# Save cleaned CSV
write.csv(
  barcelona_all_candidates,
  "Data/potential cooling centres/barcelona_all_candidates.csv",
  row.names = FALSE
)
```

```{r check on removed duplicates}
# Projected geometries of removed candidates
barcelona_removed_candidates <- barcelona_all_facilities_proj[lengths(barcelona_nearby_matches) > 0, ]

# Indices of nearest matches from existing cooling centres
barcelona_matched_indices <- barcelona_nearby_matches[lengths(barcelona_nearby_matches) > 0]
matched_indices_flat <- unlist(lapply(barcelona_matched_indices, function(x) x[[1]]))

# Get matched geometries and names from existing centres
barcelona_matched_existing <- barcelona_existing_proj[matched_indices_flat, ]
barcelona_matched_existing_names <- barcelona_existing$name[matched_indices_flat]

# Combine removed candidates with matched centre info
barcelona_matched_pairs <- cbind(
  barcelona_removed_candidates,
  matched_name = barcelona_matched_existing_names,
  matched_lon = st_coordinates(barcelona_matched_existing)[, 1],
  matched_lat = st_coordinates(barcelona_matched_existing)[, 2]
)

# View the result
View(barcelona_matched_pairs)
head(barcelona_matched_pairs)

# Save removed pairs CSV
write.csv(
  barcelona_matched_pairs,
  "Data/potential cooling centres/barcelona_removed_candidates.csv",
  row.names = FALSE
)
```