---
title: "bologna_all_candidates"
output: html_document
date: "2025-09-10"
---

```{r setup}
library(dplyr)
```

```{r read-csv-files}
# Read all six CSV files
bologna_community_centres <- read.csv("Data/potential cooling centres/bologna_community_centres.csv", stringsAsFactors = FALSE, sep = ",")
bologna_libraries <- read.csv("Data/potential cooling centres/bologna_libraries.csv", stringsAsFactors = FALSE, sep = ",")
bologna_museum <- read.csv("Data/potential cooling centres/bologna_museum.csv", stringsAsFactors = FALSE, sep = ",")
bologna_schools <- read.csv("Data/potential cooling centres/bologna_schools.csv", stringsAsFactors = FALSE, sep = ",")
bologna_social_centres <- read.csv("Data/potential cooling centres/bologna_social_centres.csv", stringsAsFactors = FALSE, sep = ",")
bologna_university <- read.csv("Data/potential cooling centres/bologna_university.csv", stringsAsFactors = FALSE, sep = ",")
```

```{r add-facility-type}
# Add a column to identify the facility type for each dataset
bologna_community_centres$facility_category <- "community_centre"
bologna_libraries$facility_category <- "library"
bologna_museum$facility_category <- "museum"
bologna_schools$facility_category <- "school"
bologna_social_centres$facility_category <- "social_centre"
bologna_university$facility_category <- "university"
```

```{r check-columns}
# Check what columns exist in each dataset
cat("Columns in each dataset:\n")
cat("Community centres:", paste(names(bologna_community_centres), collapse = ", "), "\n\n")
cat("Libraries:", paste(names(bologna_libraries), collapse = ", "), "\n\n")
cat("Museums:", paste(names(bologna_museum), collapse = ", "), "\n\n")
cat("Schools:", paste(names(bologna_schools), collapse = ", "), "\n\n")
cat("Social centres:", paste(names(bologna_social_centres), collapse = ", "), "\n\n")
cat("Universities:", paste(names(bologna_university), collapse = ", "), "\n\n")

# Get all unique columns across all datasets
all_columns <- unique(c(
  names(bologna_community_centres),
  names(bologna_libraries),
  names(bologna_museum),
  names(bologna_schools),
  names(bologna_social_centres),
  names(bologna_university)
))

cat("All unique columns:", paste(all_columns, collapse = ", "), "\n")
```

```{r combine-datasets}
# Use bind_rows to combine all datasets
# This automatically fills missing columns with NA
bologna_all_facilities <- bind_rows(
  bologna_community_centres,
  bologna_libraries,
  bologna_museum,
  bologna_schools,
  bologna_social_centres,
  bologna_university
)

# Drop the amenity and tourism columns as we added facility type as consistent type column
bologna_all_facilities <- bologna_all_facilities %>%
  select(-any_of(c("amenity", "tourism")))


# Check the result
cat("Combined dataset dimensions:", nrow(bologna_all_facilities), "rows x", ncol(bologna_all_facilities), "columns\n")
cat("Final columns:", paste(names(bologna_all_facilities), collapse = ", "), "\n")
```

```{r summary-stats}
# Summary statistics
cat("\nSummary of combined dataset:\n")
cat("Total facilities:", nrow(bologna_all_facilities), "\n")

cat("\nFacilities by category:\n")
print(table(bologna_all_facilities$facility_category, useNA = "ifany"))

cat("\nFacilities with names:", sum(!is.na(bologna_all_facilities$name)), "\n")
cat("Facilities with coordinates:", sum(!is.na(bologna_all_facilities$x) & !is.na(bologna_all_facilities$y)), "\n")
```

```{r save-combined-data}
# Save the combined dataset
write.csv(bologna_all_facilities, "Data/potential cooling centres/bologna_all_facilities.csv", row.names = FALSE)

cat("Combined data saved as bologna_all_facilities.csv\n")
cat("Total rows:", nrow(bologna_all_facilities), "\n")
cat("Total columns:", ncol(bologna_all_facilities), "\n")
```

```{r preview-data}
# Show first few rows of combined data
cat("\nPreview of combined dataset:\n")
head(bologna_all_facilities, 10)
```

```{r remove facilities that are cooling centres already}
# Read the CSV files
bologna_existing <- read.csv("Data/existing cooling centres/bologna_existing_coolingcentres.csv", sep = ";")
bologna_all_facilities <- read.csv("Data/potential cooling centres/bologna_all_facilities.csv", sep = ",")

# Convert to sf objects using x and y columns
bologna_existing_sf <- st_as_sf(bologna_existing, coords = c("lon", "lat"), crs = 4326)
bologna_all_facilities_sf <- st_as_sf(bologna_all_facilities, coords = c("x", "y"), crs = 4326)

# Transform to a projected CRS to measure in meters
# EPSG:32632 is common for bologna 
bologna_existing_proj <- st_transform(bologna_existing_sf, 32632)
bologna_all_facilities_proj <- st_transform(bologna_all_facilities_sf, 32632)

# Find all facilities within 50 meters of existing cooling centres
bologna_nearby_matches <- st_is_within_distance(bologna_all_facilities_proj, bologna_existing_proj, dist = 50)

# Keep only facilities that are NOT within 20m of any existing cooling centre
bologna_not_near_existing <- lengths(bologna_nearby_matches) == 0
bologna_all_candidates <- bologna_all_facilities[bologna_not_near_existing, ]

# Save cleaned CSV
write.csv(
  bologna_all_candidates,
  "Data/potential cooling centres/bologna_all_candidates.csv",
  row.names = FALSE
)
```

```{r check on removed duplicates}
# View deleted duplicates
# Projected geometries of removed candidates
bologna_removed_candidates <- bologna_all_facilities_proj[lengths(bologna_nearby_matches) > 0, ]

# Indices of nearest matches from existing cooling centres
bologna_matched_indices <- bologna_nearby_matches[lengths(bologna_nearby_matches) > 0]
matched_indices_flat <- unlist(lapply(bologna_matched_indices, function(x) x[[1]]))

# Get matched geometries and names from existing centres
bologna_matched_existing <- bologna_existing_proj[matched_indices_flat, ]
bologna_matched_existing_names <- bologna_existing$name[matched_indices_flat]

# Combine removed candidates with matched centre info
bologna_matched_pairs <- cbind(
  bologna_removed_candidates,
  matched_name = bologna_matched_existing_names,
  matched_lon = st_coordinates(bologna_matched_existing)[, 1],
  matched_lat = st_coordinates(bologna_matched_existing)[, 2]
)

# View the result
View(bologna_matched_pairs)
head(bologna_matched_pairs)
```