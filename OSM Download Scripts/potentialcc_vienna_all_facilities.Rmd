---
title: "vienna_all_candidates"
output: html_document
date: "2025-09-10"
---

```{r setup}
library(dplyr)
library(sf)
```

```{r read-csv-files}
# Read all six CSV files
vienna_community_centres <- read.csv("Data/potential cooling centres/vienna_community_centres.csv", stringsAsFactors = FALSE, sep = ",")
vienna_libraries <- read.csv("Data/potential cooling centres/vienna_libraries.csv", stringsAsFactors = FALSE, sep = ",")
vienna_museum <- read.csv("Data/potential cooling centres/vienna_museum.csv", stringsAsFactors = FALSE, sep = ",")
vienna_schools <- read.csv("Data/potential cooling centres/vienna_schools.csv", stringsAsFactors = FALSE, sep = ",")
vienna_social_centres <- read.csv("Data/potential cooling centres/vienna_social_centres.csv", stringsAsFactors = FALSE, sep = ",")
vienna_university <- read.csv("Data/potential cooling centres/vienna_university.csv", stringsAsFactors = FALSE, sep = ",")
```

```{r add-facility-type}
# Add a column to identify the facility type for each dataset
vienna_community_centres$facility_category <- "community_centre"
vienna_libraries$facility_category <- "library"
vienna_museum$facility_category <- "museum"
vienna_schools$facility_category <- "school"
vienna_social_centres$facility_category <- "social_centre"
vienna_university$facility_category <- "university"
```

```{r check-columns}
# Check what columns exist in each dataset
cat("Columns in each dataset:\n")
cat("Community centres:", paste(names(vienna_community_centres), collapse = ", "), "\n\n")
cat("Libraries:", paste(names(vienna_libraries), collapse = ", "), "\n\n")
cat("Museums:", paste(names(vienna_museum), collapse = ", "), "\n\n")
cat("Schools:", paste(names(vienna_schools), collapse = ", "), "\n\n")
cat("Social centres:", paste(names(vienna_social_centres), collapse = ", "), "\n\n")
cat("Universities:", paste(names(vienna_university), collapse = ", "), "\n\n")

# Get all unique columns across all datasets
all_columns <- unique(c(
  names(vienna_community_centres),
  names(vienna_libraries),
  names(vienna_museum),
  names(vienna_schools),
  names(vienna_social_centres),
  names(vienna_university)
))

cat("All unique columns:", paste(all_columns, collapse = ", "), "\n")
```

```{r combine-datasets}
# Use bind_rows to combine all datasets
# This automatically fills missing columns with NA
vienna_all_facilities <- bind_rows(
  vienna_community_centres,
  vienna_libraries,
  vienna_museum,
  vienna_schools,
  vienna_social_centres,
  vienna_university
)

# Drop the amenity and tourism columns as we added facility type as consistent type column
vienna_all_facilities <- vienna_all_facilities %>%
  select(-any_of(c("amenity", "tourism")))


# Check the result
cat("Combined dataset dimensions:", nrow(vienna_all_facilities), "rows x", ncol(vienna_all_facilities), "columns\n")
cat("Final columns:", paste(names(vienna_all_facilities), collapse = ", "), "\n")
```

```{r summary-stats}
# Summary statistics
cat("\nSummary of combined dataset:\n")
cat("Total facilities:", nrow(vienna_all_facilities), "\n")

cat("\nFacilities by category:\n")
print(table(vienna_all_facilities$facility_category, useNA = "ifany"))

cat("\nFacilities with names:", sum(!is.na(vienna_all_facilities$name)), "\n")
cat("Facilities with coordinates:", sum(!is.na(vienna_all_facilities$x) & !is.na(vienna_all_facilities$y)), "\n")
```

```{r save-combined-data}
# Save the combined dataset
write.csv(vienna_all_facilities, "Data/potential cooling centres/vienna_all_facilities.csv", row.names = FALSE)

cat("Combined data saved as vienna_all_facilities.csv\n")
cat("Total rows:", nrow(vienna_all_facilities), "\n")
cat("Total columns:", ncol(vienna_all_facilities), "\n")
```

```{r preview-data}
# Show first few rows of combined data
cat("\nPreview of combined dataset:\n")
head(vienna_all_facilities, 10)
```

```{r remove facilities that are cooling centres already}
# Read the CSV files
vienna_existing <- read.csv("Data/existing cooling centres/vienna_existing_coolingcentres.csv", sep = ";")
vienna_all_facilities <- read.csv("Data/potential cooling centres/vienna_all_facilities.csv", sep = ";")

# Convert to sf objects using x and y columns
vienna_existing_sf <- st_as_sf(vienna_existing, coords = c("lon", "lat"), crs = 4326)
vienna_all_facilities_sf <- st_as_sf(vienna_all_facilities, coords = c("x", "y"), crs = 4326)

# Transform to a projected CRS to measure in meters
# EPSG:31287 is common for Vienna (MGI / Austria Lambert)
vienna_existing_proj <- st_transform(vienna_existing_sf, 31287)
vienna_all_facilities_proj <- st_transform(vienna_all_facilities_sf, 31287)

# Find all facilities within 50 meters of existing cooling centres
vienna_nearby_matches <- st_is_within_distance(vienna_all_facilities_proj, vienna_existing_proj, dist = 50)

# Keep only facilities that are NOT within 20m of any existing cooling centre
vienna_not_near_existing <- lengths(vienna_nearby_matches) == 0
vienna_all_candidates <- vienna_all_facilities[vienna_not_near_existing, ]

# Save cleaned CSV
write.csv(
  vienna_all_candidates,
  "Data/potential cooling centres/vienna_all_candidates.csv",
  row.names = FALSE
)
```

```{r check on removed duplicates}
# View deleted duplicates
# Projected geometries of removed candidates
vienna_removed_candidates <- vienna_all_facilities_proj[lengths(vienna_nearby_matches) > 0, ]

# Indices of nearest matches from existing cooling centres
vienna_matched_indices <- vienna_nearby_matches[lengths(vienna_nearby_matches) > 0]
matched_indices_flat <- unlist(lapply(vienna_matched_indices, function(x) x[[1]]))

# Get matched geometries and names from existing centres
vienna_matched_existing <- vienna_existing_proj[matched_indices_flat, ]
vienna_matched_existing_names <- vienna_existing$name[matched_indices_flat]

# Combine removed candidates with matched centre info
vienna_matched_pairs <- cbind(
  vienna_removed_candidates,
  matched_name = vienna_matched_existing_names,
  matched_lon = st_coordinates(vienna_matched_existing)[, 1],
  matched_lat = st_coordinates(vienna_matched_existing)[, 2]
)

# View the result
View(vienna_matched_pairs)
head(vienna_matched_pairs)
```